<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="OrdersListManageMap"  xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="SqlMap.xsd">
  <alias>
    <typeAlias alias="OrdersListManage" assembly="DataAccess.dll" type="DataAccess.Domain.OrdersListManage" />
  </alias>
  <resultMaps>
    <resultMap id="OrdersListManageResult" class="OrdersListManage">
      <result property="Id" column="ID" type="long" dbType="long"/>
      <result property="OrdersNo" column="OrdersNo" type="string" dbType="varchar"/>
      <result property="OrdersType" column="OrdersType" type="string" dbType="varchar"/>
      <result property="ConsumerNo" column="ConsumerNo" type="string" dbType="varchar"/>
      <result property="SeatNo" column="SeatNo" type="string" dbType="varchar"/>
      <result property="TotalMoney" column="TotalMoney" type="single" dbType="Real"/>
      <result property="DisMoney" column="DisMoney" type="single" dbType="Real"/>
      <result property="FreeMoney" column="FreeMoney" type="single" dbType="Real"/>
      <result property="ClearMoney" column="ClearMoney" type="single" dbType="Real"/>
      <result property="PayMoney" column="PayMoney" type="single" dbType="Real"/>
      <result property="OrdersStatus" column="OrdersStatus" type="string" dbType="varchar"/>
      <result property="PayStatus" column="PayStatus" type="string" dbType="varchar"/>
      <result property="CreateUser" column="CreateUser" type="string" dbType="varchar"/>
      <result property="CreateTime" column="CreateTime" type="DateTime" dbType="DateTime"/>
      <result property="MarketNo" column="MarketNo" type="string" dbType="varchar"/>
      <result property="UpdUser" column="UpdUser" type="string" dbType="varchar"/>
      <result property="UpdTime" column="UpdTime" type="DateTime" dbType="DateTime"/>
    </resultMap>
  </resultMaps>
  <parameterMaps>
    <parameterMap id="MyOrdersListManage" class="Hashtable">

      <parameter property="startDate" />
      <parameter property="endDate" />

    </parameterMap>
  </parameterMaps>
  <statements>
    <select id="SelectOrdersListManageByOrdersNo" parameterClass="string" resultClass="OrdersListManage">
      SELECT ID AS Id,OrdersNo AS OrdersNo,OrdersType AS OrdersType,ConsumerNo AS ConsumerNo,SeatNo AS SeatNo,TotalMoney AS TotalMoney,DisMoney AS DisMoney,FreeMoney AS FreeMoney,ClearMoney AS ClearMoney,PayMoney AS PayMoney,OrdersStatus AS OrdersStatus,PayStatus AS PayStatus,CreateUser AS CreateUser,CreateTime AS CreateTime,MarketNo AS MarketNo,UpdUser AS UpdUser,UpdTime AS UpdTime
      FROM OrdersListManage
      <dynamic prepend="WHERE">
        <isParameterPresent>
          OrdersNo = #value#
        </isParameterPresent>
      </dynamic>
    </select>
    <select id="SelectOrdersListManage3" parameterClass="string" resultClass="Hashtable">
      select olm.ID,olm.OrdersNo,olm.OrdersStatus,olm.OrdersType,olm.PayStatus,olm.ConsumerNo,olm.SeatNo,olm.TotalMoney,olm.DisMoney,olm.FreeMoney,olm.ClearMoney,olm.PayMoney,od.TransNo,od.MenuCode,od.MenuName,od.MenuPrice,od.SendCount,od.TotalMoney as TotalMoney2,od.DiscountMoney,od.PayMoney as PayMoney2,od.PayWay,od.Set1_Value,od.Set2_Value,od.Set3_Value,od.Set4_Value,SaleUnit,olm.CreateTime,olm.UpdTime,od.MainItemsNo as ID2  from OrdersListManage as olm join OrdersDetail as od on olm.OrdersNo=od.OrdersNo where olm.OrdersNo=#value#
    </select>
    
    <select id="SelectOrdersListManage" parameterClass="string" resultClass="OrdersListManage">
      SELECT ID AS Id,OrdersNo AS OrdersNo,OrdersType AS OrdersType,ConsumerNo AS ConsumerNo,SeatNo AS SeatNo,TotalMoney AS TotalMoney,DisMoney AS DisMoney,FreeMoney AS FreeMoney,ClearMoney AS ClearMoney,PayMoney AS PayMoney,OrdersStatus AS OrdersStatus,PayStatus AS PayStatus,CreateUser AS CreateUser,CreateTime AS CreateTime,MarketNo AS MarketNo,UpdUser AS UpdUser,UpdTime AS UpdTime
      FROM OrdersListManage
      <dynamic prepend="WHERE">
        <isParameterPresent>
          ID = #value#
        </isParameterPresent>
      </dynamic>
    </select>
    <select id="SelectOrdersListManage2" parameterClass="string" resultClass="OrdersListManage">
      SELECT ID AS Id,OrdersNo AS OrdersNo,OrdersType AS OrdersType,ConsumerNo AS ConsumerNo,SeatNo AS SeatNo,TotalMoney AS TotalMoney,DisMoney AS DisMoney,FreeMoney AS FreeMoney,ClearMoney AS ClearMoney,PayMoney AS PayMoney,OrdersStatus AS OrdersStatus,PayStatus AS PayStatus,CreateUser AS CreateUser,CreateTime AS CreateTime,MarketNo AS MarketNo,UpdUser AS UpdUser,UpdTime AS UpdTime
      FROM OrdersListManage where OrdersNo=#value#

    </select>
    <select id="SelectOrdersListManageSeat" parameterClass="string" resultClass="OrdersListManage">
      SELECT ID AS Id,OrdersNo AS OrdersNo,OrdersType AS OrdersType,ConsumerNo AS ConsumerNo,SeatNo AS SeatNo,TotalMoney AS TotalMoney,DisMoney AS DisMoney,FreeMoney AS FreeMoney,ClearMoney AS ClearMoney,PayMoney AS PayMoney,OrdersStatus AS OrdersStatus,PayStatus AS PayStatus,CreateUser AS CreateUser,CreateTime AS CreateTime,UpdUser AS UpdUser,UpdTime AS UpdTime
      FROM OrdersListManage
      <dynamic prepend="WHERE">
        <isParameterPresent>
          SeatNo = #SeatNo#
        </isParameterPresent>
      </dynamic>
    </select>
    <select id="SelectOrdersListManageBySeatNo" parameterClass="Hashtable" resultClass="Hashtable">
      select olm.ID,olm.OrdersNo,olm.OrdersStatus,olm.OrdersType,olm.PayStatus,olm.ConsumerNo,olm.SeatNo,olm.TotalMoney,olm.DisMoney,olm.FreeMoney,olm.ClearMoney,olm.PayMoney,od.TransNo,od.MenuCode,od.MenuName,od.MenuPrice,od.SendCount,od.TotalMoney as TotalMoney2,od.DiscountMoney,od.PayMoney as PayMoney2,od.PayWay,od.Set1_Value,od.Set2_Value,od.Set3_Value,od.Set4_Value,SaleUnit,od.MainItemsNo  from OrdersListManage as olm join OrdersDetail as od on olm.OrdersNo=od.OrdersNo where SeatNo = #seatNo# and OrdersStatus=#status# ORDER BY olm.UpdTime DESC

    </select>
    <select id="PendedOrdersCount" parameterClass="Hashtable" resultClass="int" >
      SELECT count(0) from OrdersListManage where SeatNo=#seatNo# and OrdersStatus=#status#
    </select>

    <select id="SelectDetailOrdersList" parameterClass="Hashtable" resultClass="Hashtable">
		SELECT orderMaster.OrdersNo,orderMaster.OrdersType
		,orderMaster.TotalMoney,orderMaster.DisMoney,orderMaster.PayMoney
		,orderMaster.OrdersStatus,orderMaster.PayStatus,orderDetail.MenuCode,orderDetail.MenuPrice,orderDetail.SendCount,
		menu.MenuName,menu.SaleUnit from OrdersListManage  orderMaster
		inner join OrdersDetail orderDetail
		ON orderMaster.OrdersNo=orderDetail.OrdersNo
		inner JOIN MenuManage menu
		on orderDetail.MenuCode=menu.MenuNo
		<dynamic prepend=" WHERE ">
        <isNotEmpty prepend="and" property="ordersNo">
          orderMaster.OrdersNo= #ordersNo#
        </isNotEmpty>
      </dynamic>
    </select>
    <!--ccyuan-->
    <select id="SelectOrdersListManageAndPay" parameterClass="Hashtable" resultClass="Hashtable">
      SELECT (select group_concat(DISTINCT(Name))  from  PayTypeManage inner join PayManage on PayTypeManage.Code=PayManage.PayWay
      where PayManage.OrdersNo=OrdersListManage.OrdersNo  ) as Name,OrdersListManage.ID,OrdersListManage.OrdersNo, OrdersListManage.PayMoney,
      (select FieldValue.Text from FieldValue where FieldValue."Key"='OrdersStatus' and
      FieldValue.Value=OrdersListManage.OrdersStatus) as OrdersStatus,OrdersStatus as OrdersStatuss, OrdersListManage.CreateTime FROM OrdersListManage
      <dynamic prepend="WHERE">
        <isNotEmpty prepend="and" property="OrdersNo">
          OrdersListManage.OrdersNo= #OrdersNo#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="ListSet_One">
          OrdersListManage.OrdersStatus= #ListSet_One#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="OrdersStartTime">
          OrdersListManage.CreateTime>= #OrdersStartTime#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="OrdersEndTime">
          <![CDATA[ OrdersListManage.CreateTime <= #OrdersEndTime# ]]>
        </isNotEmpty>
      </dynamic>
      GROUP BY OrdersListManage.ID, OrdersListManage.OrdersNo, OrdersListManage.PayMoney,OrdersStatus
    </select>
    <select id="SelectOrdersListManageMark" parameterClass="string" resultClass="OrdersListManage">
      SELECT ID AS Id,OrdersNo AS OrdersNo,OrdersType AS OrdersType,ConsumerNo AS ConsumerNo,SeatNo AS SeatNo,TotalMoney AS TotalMoney,DisMoney AS DisMoney,FreeMoney AS FreeMoney,ClearMoney AS ClearMoney,PayMoney AS PayMoney,OrdersStatus AS OrdersStatus,PayStatus AS PayStatus,CreateUser AS CreateUser,CreateTime AS CreateTime,MarketNo AS MarketNo,UpdUser AS UpdUser,UpdTime AS UpdTime
      FROM OrdersListManage
      <dynamic prepend="WHERE">
        <isParameterPresent>
          MarketNo = #value#
        </isParameterPresent>
      </dynamic>
    </select>
  
    <select id="SelectOrdersListManageAndPayBack" parameterClass="string" resultClass="Hashtable">
      SELECT  OrdersListManage.OrdersNo, OrdersListManage.PayMoney,OrdersListManage.CreateTime,
      (select sum(pm.PayMoney) from PayManage as pm where pm.OrdersNo=OrdersListManage.OrdersNo and pm.PayType=2) as BackMoney
      FROM OrdersListManage inner join PayManage on PayManage.OrdersNo=OrdersListManage.OrdersNo
      <dynamic prepend="WHERE">
        <isParameterPresent>
          OrdersListManage.ID = #value#
        </isParameterPresent>
      </dynamic>
    </select>
    
    <insert id="InsertOrdersListManage" parameterClass="OrdersListManage">
      INSERT INTO OrdersListManage
      (OrdersNo,OrdersType,ConsumerNo,SeatNo,TotalMoney,DisMoney,FreeMoney,ClearMoney,PayMoney,OrdersStatus,PayStatus,CreateUser,CreateTime,MarketNo,UpdUser,UpdTime)
      VALUES(#OrdersNo#,#OrdersType#,#ConsumerNo#,#SeatNo#,#TotalMoney#,#DisMoney#,#FreeMoney#,#ClearMoney#,#PayMoney#,#OrdersStatus#,#PayStatus#,#CreateUser#,#CreateTime#,#MarketNo#,#UpdUser#,#UpdTime#)
      <selectKey resultClass="long" type="post" property="Id">
        SELECT LAST_INSERT_ROWID() as value
      </selectKey>
    </insert>
    <update id="UpdateOrdersListManage" parameterClass="OrdersListManage">
      UPDATE OrdersListManage
      SET OrdersNo=#OrdersNo#,OrdersType=#OrdersType#,ConsumerNo=#ConsumerNo#,SeatNo=#SeatNo#,TotalMoney=#TotalMoney#,DisMoney=#DisMoney#,FreeMoney=#FreeMoney#,ClearMoney=#ClearMoney#,PayMoney=#PayMoney#,OrdersStatus=#OrdersStatus#,PayStatus=#PayStatus#,CreateUser=#CreateUser#,CreateTime=#CreateTime#,MarketNo=#MarketNo#,UpdUser=#UpdUser#,UpdTime=#UpdTime#
      WHERE ID = #Id#
    </update>
    <update id="UpdateOrdersListManage2" parameterClass="OrdersListManage">
      UPDATE OrdersListManage
      SET OrdersType=#OrdersType#,ConsumerNo=#ConsumerNo#,SeatNo=#SeatNo#,TotalMoney=#TotalMoney#,DisMoney=#DisMoney#,FreeMoney=#FreeMoney#,ClearMoney=#ClearMoney#,PayMoney=#PayMoney#,OrdersStatus=#OrdersStatus#,PayStatus=#PayStatus#,MarketNo=#MarketNo#,UpdUser=#UpdUser#,UpdTime=#UpdTime#
      WHERE OrdersNo = #OrdersNo#
    </update>
    <update id="UpdateOrdersListManageSend" parameterClass="OrdersListManage">
      UPDATE OrdersListManage
      SET PayMoney=#PayMoney#,OrdersStatus=#OrdersStatus#,PayStatus=#PayStatus#,UpdUser=#UpdUser#,UpdTime=#UpdTime#
      WHERE OrdersNo = #OrdersNo#
    </update>
	<update id="UpdateOrdersListManageSendSett" parameterClass="OrdersListManage">
		UPDATE OrdersListManage
		SET OrdersStatus=#OrdersStatus#,PayStatus=#PayStatus#,UpdUser=#UpdUser#,UpdTime=#UpdTime#
		WHERE OrdersNo = #OrdersNo#
	</update>
    <update id="UpdateOrderStatus" parameterClass="Hashtable">
      UPDATE OrdersListManage
      SET OrdersStatus=#OrdersStatus#
      WHERE OrdersNo = #OrdersNo#
    </update>
    <delete id="DeleteOrdersListManage" parameterClass="string">
      DELETE FROM OrdersListManage
      WHERE ID = #value#
    </delete>
    <delete id="DeleteOrdersListManage2" parameterClass="string">
      DELETE FROM OrdersListManage
      WHERE OrdersNo = #OrdersNo#
    </delete>
    <delete id="DeleteOrdersListManagePay" parameterMap="MyOrdersListManage">
      DELETE FROM OrdersListManage WHERE OrdersNo IN(SELECT OrdersNo FROM PayManage
      <dynamic prepend=" where ">
        <isNotEmpty prepend="and" property="startDate">
          OwnerTime>= #startDate#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="endDate">
          <![CDATA[ OwnerTime <= #endDate# )]]>
        </isNotEmpty>
      </dynamic>
    </delete>
    <delete id="DeleteOrdersListManageOwner" parameterMap="MyOrdersListManage">
      DELETE FROM OrdersListManage 
      <dynamic prepend=" where ">
        <isNotEmpty prepend="and" property="startDate">
          CreateTime>= #startDate#
        </isNotEmpty>
        <isNotEmpty prepend="and" property="endDate">
          <![CDATA[ CreateTime <= #endDate# ]]>
        </isNotEmpty>
        and OrdersNo not in(Select OrdersNo from PayManage)
      </dynamic>
    </delete>
  </statements>
</sqlMap>
